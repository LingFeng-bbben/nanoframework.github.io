<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>

  <head>
    <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>CLR Managed heap definition | .NET nanoFramework Documentation </title>
      <meta name="viewport" content="width=device-width">
      <meta name="title" content="CLR Managed heap definition | .NET nanoFramework Documentation ">
    

      <link rel="apple-touch-icon" sizes="180x180" href="../../../favicons/apple-touch-icon.png">
      <link rel="icon" type="image/png" sizes="32x32" href="../../../favicons/favicon-32x32.png">
      <link rel="icon" type="image/png" sizes="16x16" href="../../../favicons/favicon-16x16.png">
      <link rel="manifest" href="../../../favicons/site.webmanifest">
      <link rel="shortcut icon" type="image/x-icon" href="../../../favicon.ico">
      <link rel="mask-icon" href="../../../favicons/safari-pinned-tab.svg" color="#179b88">
      <meta name="msapplication-config" content="../../../favicons/browserconfig.xml">
      <meta name="msapplication-TileColor" content="#222222">
      <meta name="theme-color" content="#222222">

      <link rel="stylesheet" href="../../../styles/docfx.vendor.min.css">
      <link rel="stylesheet" href="../../../styles/docfx.css">
      <link rel="stylesheet" href="../../../styles/main.css">
      <meta property="docfx:navrel" content="../../../toc.html">
      <meta property="docfx:tocrel" content="../../../x-cross/toc.html">
    
    <meta property="docfx:rel" content="../../../">
    
  </head>  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a class="navbar-brand" href="../../../index.html">
                <img id="logo" class="svg" src="../../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>

        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">

        <div id="search-results">
          <div class="search-list">Search Results for <span></span></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">

        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="clr-managed-heap-definition">CLR Managed heap definition</h1>

<h2 id="about-this-document">About this document</h2>
<p>This document describes how the CLR manged heap is defined as a ChibiOS target.</p>
<p>For STM32 based devices:
The configurations are chained by linker files:</p>
<ul>
<li>the target linker file provided for the nanoCLR in the target board folder, e.g. <a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/ST_NUCLEO64_F091RC/nanoCLR/STM32F091xC_CLR.ld">STM32F091xC.ld</a> and from within calls rules.ld <strong>except</strong> the F7 series which calls rules_clr.ld, rules_code.ld, rules_data.ld and rules_stacks.ld directly.</li>
<li><a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/_common/rules.ld">rules.ld</a> (which is common to all STM32 based ChibiOS targets and calls the next set of linker files)</li>
<li><a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/_common/rules_clr.ld">rules_clr.ld</a>, <a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/_common/rules_code.ld">rules_code.ld</a>, <a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/_common/rules_data.ld">rules_data.ld</a> and <a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/_common/rules_stacks.ld">rules_stacks.ld</a></li>
</ul>
<h2 id="managed-heap-location-and-size">Managed heap location and size</h2>
<p>The CLR managed heap can be located on the target board at any RAM address where space available. Either internal or external.</p>
<p>It will be placed (considering the RAM region defined) after the region containing the CRT heap (if it's assigned to that same RAM region) and right before the Vector table copy in RAM (if it is assigned to the same RAM region).</p>
<p>This empowers developers to create new target boards with maximum flexibility of where to locate the CLR managed heap and its respective size.</p>
<h3 id="definition-the-clr-managed-heap-location">Definition the CLR managed heap location</h3>
<p>The location of the CLR managed heap is set in in target linker file provided for nanoCLR in the target boards folder, e.g. <a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/ST_NUCLEO64_F091RC/nanoCLR/STM32F091xC_CLR.ld">STM32F091xC_CLR.ld</a></p>
<p>For example the line (usually toward the end of the file) will contain something similar to <code>REGION_ALIAS(&quot;CLR_MANAGED_HEAP_RAM&quot;, ram0);</code>. The example stated here defines CLR manged heap location as being set in the <em>ram0</em> region. The RAM regions and respective sizes are defined in the same file. For further information, please check the ChibiOS documentation for details on how to define further RAM regions.</p>
<h3 id="size-of-the-clr-managed-heap">Size of the CLR managed heap</h3>
<p>The size of the CLR managed heap is automatically adjusted to take all the available RAM space after the CRT heap (if it's assigned to that same RAM region).</p>
<p>It maybe be required to adjust the size of the CRT heap. This is set in the CMake file of the target board, e.g. <a href="https://github.com/nanoframework/nf-interpreter/tree/main/targets/ChibiOS/ST_NUCLEO64_F091RC/CMakeLists.txt">CMakeLists.txt</a>.
Look for the <code>__crt_heap_size__</code> definition in a line that contain something similar to <code>--defsym=__crt_heap_size__=0x800</code>. In the example stated here the size of CRT heap is being set to 0x800.</p>
<p>When defining the size you need to take into account several factors:</p>
<ul>
<li>the total available size of the region where it's being placed</li>
<li>if there are initialized variables assigned to this region how much space they are taking</li>
<li>if the CRT heap is located in this region and the size left for it is enough</li>
</ul>
<p>The linker is only able to determine whether there is enough room for all of these factors and it will only complain if there isn't. However it can not determine if the CRT heap (just like the CRT heap) is large enough for the running requirements. That is up to the target board developer.
For a detailed overview on the final memory map you may want to check the <em>nanoCLR.map</em> that will be located in the build folder after a successful build. Look for the regions called <code>.heap</code> and <code>.clr_managed_heap</code> to see the final addresses where those were placed.</p>

</article>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/nanoframework/nanoframework.github.io/blob/pages-source/content/hal-pal/chibios/clr-managed-heap.md/#L1" class="contribution-link">Edit this page</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In this article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      
      <span>Copyright © 2023 nanoFramework Contributors<br>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>    </div>

    <script type="text/javascript" src="../../../styles/docfx.vendor.min.js"></script>
    <script type="text/javascript" src="../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../styles/main.js"></script>
  </body>
</html>
